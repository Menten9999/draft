<!DOCTYPE html>
<head>
    <meta charset="UTF-8">
    <title>管理者ページ</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .reset-button { background-color: #dc3545; margin-left: 15px; }
        .reset-button:hover { background-color: #c82333; }
        .lottery-button { background-color: #ffc107; color: black; }
        .lottery-button:hover { background-color: #e0a800; }
        #lottery-status-container { margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; }
    </style>
</head>
<body>
<main class="main">
    <h1 class="title">ドラフト管理画面</h1>
    <div class="container">
        <div class="status-section">
            <h2>現在選択中の選手 (第<span id="round-number">1</span>巡)</h2>
            <ul id="current-selection-list"></ul>
        </div>
        <div class="acquired-section">
            <h2>各チーム獲得選手一覧</h2>
            <ul id="acquired-players-list"></ul>
        </div>
    </div>
    <div id="lottery-status-container"></div>
    <div class="controls">
        <button onclick="processSelections()">選択を処理</button>
        <button onclick="resetAllData()" class="reset-button">ドラフトをリセット</button>
    </div>
</main>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="firebase-config.js"></script>
<script>
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const teams = ['team1', 'team2', 'team3', 'team4']; 

    const roundRef = database.ref('round');
    const currentSelectionsRef = database.ref('currentSelections');
    const acquiredPlayersRef = database.ref('acquiredPlayers');
    const teamStatusRef = database.ref('teamStatus');
    const systemAlertRef = database.ref('systemAlert');
    const selectionConfirmedRef = database.ref('selectionConfirmed');
    const teamsPassedRef = database.ref('teamsPassed');
    const lotteryRef = database.ref('lotteries');

    roundRef.on('value', snapshot => {
        document.getElementById('round-number').textContent = snapshot.val() || 1;
    });

    currentSelectionsRef.on('value', snapshot => {
        const list = document.getElementById('current-selection-list');
        list.innerHTML = '';
        const selections = snapshot.val() || {};
        teams.forEach((team, index) => {
            const player = selections[team] || '未選択';
            const teamName = `チーム${index + 1}`;
            const li = document.createElement('li');
            li.textContent = `${teamName}: ${player}`;
            list.appendChild(li);
        });
    });

    acquiredPlayersRef.on('value', snapshot => {
        const list = document.getElementById('acquired-players-list');
        list.innerHTML = '';
        const allAcquired = snapshot.val() || {};
        teams.forEach((team, index) => {
            const teamName = `チーム${index + 1}`;
            const players = allAcquired[team] ? Object.values(allAcquired[team]).join(', ') : 'なし';
            const li = document.createElement('li');
            li.textContent = `${teamName}: ${players}`;
            list.appendChild(li);
        });
    });

    lotteryRef.on('value', (snapshot) => {
        const lotteries = snapshot.val() || {};
        const container = document.getElementById('lottery-status-container');
        container.innerHTML = '';

        for (const player in lotteries) {
            const lotteryData = lotteries[player];
            const competingTeams = Object.keys(lotteryData.competingTeams);
            const picks = lotteryData.picks || {};
            const picksCount = Object.keys(picks).length;

            const statusDiv = document.createElement('div');
            statusDiv.innerHTML = `<h3>抽選: ${player}</h3><p>くじ引き状況: ${picksCount} / ${competingTeams.length}</p>`;

            if (picksCount === competingTeams.length) {
                const revealButton = document.createElement('button');
                revealButton.textContent = `「${player}」の抽選結果を開票`;
                revealButton.className = 'lottery-button';
                revealButton.onclick = () => revealLotteryResults(player);
                statusDiv.appendChild(revealButton);
            }
            container.appendChild(statusDiv);
        }
    });

    async function processSelections() {
        const selectionsSnapshot = await currentSelectionsRef.once('value');
        const selections = selectionsSnapshot.val() || {};
        const confirmedSnapshot = await selectionConfirmedRef.once('value');
        const confirmed = confirmedSnapshot.val() || {};
        const passedSnapshot = await teamsPassedRef.once('value');
        const passed = passedSnapshot.val() || {};
        const activeTeams = teams.filter(team => !confirmed[team] && !passed[team]);
        
        if (Object.keys(selections).length < activeTeams.length) {
            alert("まだ選択を終えていないチームがいます。");
            return;
        }

        const playerToTeams = {};
        for (const teamId in selections) {
            const player = selections[teamId];
            if (!playerToTeams[player]) playerToTeams[player] = [];
            playerToTeams[player].push(teamId);
        }

        const conflicts = {};
        const nonConflicts = {};
        for (const player in playerToTeams) {
            if (playerToTeams[player].length > 1) {
                conflicts[player] = playerToTeams[player];
            } else {
                nonConflicts[player] = playerToTeams[player];
            }
        }

        if (Object.keys(conflicts).length > 0) {
            await systemAlertRef.set("競合が発生しました。抽選画面に移行します。");
            for (const player in conflicts) {
                const competingTeams = conflicts[player];
                const lots = competingTeams.map((_, index) => ({ id: index, isPicked: false }));
                const winnerIndex = Math.floor(Math.random() * competingTeams.length);
                lots[winnerIndex].isWinner = true;

                const competingTeamsObj = {};
                competingTeams.forEach(team => { competingTeamsObj[team] = true; });

                await lotteryRef.child(player).set({
                    competingTeams: competingTeamsObj,
                    lots: lots
                });
            }
        } else {
            alert("競合はありませんでした。全チームの選択を確定します。");
        }
        
        for (const player in nonConflicts) {
            const teamId = nonConflicts[player][0];
            await acquiredPlayersRef.child(teamId).push(player);
            await teamStatusRef.child(teamId).set("交渉権獲得");
            await selectionConfirmedRef.child(teamId).set(true);
        }
        
        await currentSelectionsRef.remove();
        
        if (Object.keys(conflicts).length === 0) {
            const finalConfirmedSnapshot = await selectionConfirmedRef.once('value');
            const finalPassedSnapshot = await teamsPassedRef.once('value');
            const finalConfirmedCount = finalConfirmedSnapshot.val() ? Object.keys(finalConfirmedSnapshot.val()).length : 0;
            const finalPassedCount = finalPassedSnapshot.val() ? Object.keys(finalPassedSnapshot.val()).length : 0;
            
            if (finalConfirmedCount + finalPassedCount === teams.length) {
                const roundSnapshot = await roundRef.once('value');
                const nextRound = (roundSnapshot.val() || 1) + 1;
                
                await roundRef.set(nextRound);
                await teamStatusRef.remove();
                await selectionConfirmedRef.remove();
                
                alert(`全アクティブチームの選択が確定しました。第${nextRound}巡に移行します。`);
            }
        }
    }

    async function revealLotteryResults(player) {
        await lotteryRef.child(player).child('isRevealing').set(true);
        document.querySelectorAll('.lottery-button').forEach(b => b.disabled = true);

        const lotterySnapshot = await lotteryRef.child(player).once('value');
        const lotteryData = lotterySnapshot.val();
        if (!lotteryData) return;

        const winningLot = lotteryData.lots.find(lot => lot.isWinner);
        let winnerTeam = null;

        for (const teamId in lotteryData.picks) {
            if (lotteryData.picks[teamId] === winningLot.id) {
                winnerTeam = teamId;
                break;
            }
        }

        await acquiredPlayersRef.child(winnerTeam).push(player);

        for (const teamId of Object.keys(lotteryData.competingTeams)) {
            if (teamId === winnerTeam) {
                await teamStatusRef.child(teamId).set("交渉権獲得");
                await selectionConfirmedRef.child(teamId).set(true);
            } else {
                await teamStatusRef.child(teamId).set("落選しました。再度選手を選択してください");
            }
        }

        await lotteryRef.child(player).remove();
        await systemAlertRef.remove();

        const finalConfirmedSnapshot = await selectionConfirmedRef.once('value');
        const finalPassedSnapshot = await teamsPassedRef.once('value');
        const finalConfirmedCount = finalConfirmedSnapshot.val() ? Object.keys(finalConfirmedSnapshot.val()).length : 0;
        const finalPassedCount = finalPassedSnapshot.val() ? Object.keys(finalPassedSnapshot.val()).length : 0;
        
        if (finalConfirmedCount + finalPassedCount === teams.length) {
            const roundSnapshot = await roundRef.once('value');
            const nextRound = (roundSnapshot.val() || 1) + 1;
            
            await roundRef.set(nextRound);
            await teamStatusRef.remove();
            await selectionConfirmedRef.remove();
            
            alert(`全アクティブチームの選択が確定しました。第${nextRound}巡に移行します。`);
        }
    }
    
    async function resetAllData() {
        const confirmationText = "delete";
        const userInput = prompt(`警告：すべてのドラフトデータが完全に削除されます。「${confirmationText}」と入力してください。`);
        if (userInput === confirmationText) {
            await database.ref().set(null);
            await roundRef.set(1);
            alert("ドラフトデータが初期化されました。");
        } else if (userInput !== null) {
            alert("入力が間違っています。");
        }
    }

    history.pushState(null, null, location.href);
    window.addEventListener('popstate', function(e) {
        history.go(1);
    });
</script>
</body>
</html>